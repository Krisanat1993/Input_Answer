<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Form in LIFF</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div id="loading-message">กำลังโหลดข้อมูลผู้ใช้...</div>
    <iframe id="google-form" src="" style="display:none;"></iframe>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        async function main() {
            // ส่วนนี้เป็นโค้ดเสริมเพื่อแก้ปัญหา Cache ของ LIFF ในบางกรณี สามารถคงไว้ได้
            const originalFetch = window.fetch;
            window.fetch = async function(url, options) {
                if (url.toString().startsWith('https://liffsdk.line-scdn.net/') && url.toString().endsWith('.json')) {
                    url = url + '?ts=' + Math.random();
                }
                return originalFetch(url, options);
            };

            // --------------------------------------------------------------
            // 1. ค่าที่ต้องแก้ไข (ตรวจสอบให้แน่ใจว่าถูกต้อง)
            const liffId = "2008056238-g8p1R13n";
            // ✅ **แก้ไข:** ลบพารามิเตอร์ท้าย URL ออก ให้เหลือแค่ URL หลัก
            const formBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSffZez6krk1nl-bGWIfn6xGExspTfC4ZAdU4kbuVg4iPFGNzQ/viewform";
            const userIdEntry = "entry.718859599";
            // --------------------------------------------------------------

            try {
                // 2. เริ่มต้น LIFF
                await liff.init({ liffId: liffId });

                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                // 3. ดึงโปรไฟล์ผู้ใช้เพื่อเอา userId
                const profile = await liff.getProfile();
                const userId = profile.userId;

                // 4. ✅ **แก้ไข:** สร้าง URL ที่ถูกต้องในขั้นตอนเดียว
                // ใช้ '?' สำหรับพารามิเตอร์ตัวแรก (embedded=true)
                // และใช้ '&' สำหรับพารามิเตอร์ตัวถัดไป (entry.xxx=userId)
                const finalUrl = `${formBaseUrl}?embedded=true&${userIdEntry}=${userId}`;

                // 5. แสดงฟอร์มและซ่อนข้อความ Loading
                const iframe = document.getElementById('google-form');
                const loadingMessage = document.getElementById('loading-message');
                
                iframe.src = finalUrl;
                iframe.style.display = 'block';
                loadingMessage.style.display = 'none';

            } catch (error) {
                // หากเกิดข้อผิดพลาด ให้แสดงบนหน้าจอ
                document.getElementById('loading-message').innerText = "เกิดข้อผิดพลาด: " + error;
            }
        }

        main();
    </script>
</body>
</html>
